{% extends 'base.html' %}
{% load apptags %}
{% load humanize %}
{% load staticfiles %}

{% block head_title %}{{ challenge.name }} : {{ challenge.distance|floatformat:"-1" }} mile challenge, {{ approvedActivities|commaSeparated}}{% endblock %}

{% block head_misc %}
    <meta property="og:type" content="website" />
    <meta property="og:url" content="{{ request.build_absolute_uri }}" />
    <link rel="canonical" href="{{ request.build_absolute_uri }}">

    <meta property="og:title" content="{{ challenge.name }} | Fit Crown" />
    <meta property="og:image" content="{{ request|hostUrl }}/static/img/running.jpg" />
{% endblock %}


{% block head_scripts %}
    {{ block.super }}
{% endblock %}

{% block head_css %}
    {{ block.super }}
{% endblock %}

{% block content %}
    <div class="page-header">
        <h2>{{ challenge.name }}</h2>
    </div>

	<p class="lead">{{ challenge.description|safe }}</p>

	<p class="lead">
		{% if not challenge.hasStarted %}
			This Challenge will start in {{ challenge.startdate|timeuntil }}.
		{% elif challenge.hasEnded %}
			This Challenge ended {{ challenge.enddate|timesince }} ago.
			{% if challenge.reconciled and challenge.disbursementAmount > 0 %}
				<strong>{{ challenge.numWinners }} players won ${{ challenge.disbursementAmount }} each.</strong>
			{% endif %}
		{% else%}
			<span data-waters="countdown" data-targetdate="{{ challenge.enddate|fullDate }}" data-numberpadding="1">
                This Challenge is under way, there's <span class="days-value"></span> Days, <span class="hours-value"></span> Hours, <span class="minutes-value"></span> Minutes and <span class="seconds-value"></span> Seconds left!
            </span>
		{% endif %}
	</p>

	<h4>Challenge Details</h4>
	<div class="challenge-header">
		<div class="row">
			<div class="challenge-info col-lg-3 col-sm-3 col-xs-6">
				<div class="challenge-label">Distance</div>
				<div class="challenge-value">{{ challenge.distance|floatformat:"-1" }} miles</div>
			</div>
			<div class="challenge-info col-lg-3 col-sm-3 col-xs-6">
				<div class="challenge-label">Activities</div>
				<div class="challenge-value">{{ approvedActivities|activityIcons }}</div>
			</div>
			<div class="challenge-info col-lg-3 col-sm-3 col-xs-6">
				<div class="challenge-label">Duration</div>
				<div class="challenge-value">{{ challenge.numDays }} Days</div>
			</div>
			<div class="challenge-info col-lg-3 col-sm-3 col-xs-6">
				{% if not challenge.hasStarted %}
					<div class="challenge-label">Starts on</div>
					<div class="challenge-value">{{ challenge.startdate|date:"N j" }}</div>
				{% elif not challenge.hasEnded %}
					<div class="challenge-label">Ends on</div>
					<div class="challenge-value">{{ challenge.enddate|date:"N j" }}</div>
				{% else %}
					<div class="challenge-label">Ended on</div>
					<div class="challenge-value">{{ challenge.enddate|date:"N j, y" }}</div>
				{% endif %}
			</div>
			<div class="challenge-info col-lg-3 col-sm-3 col-xs-6">
				<div class="challenge-label">Bet</div>
				<div class="challenge-value">${{ challenge.ante|floatformat:"-2"|intcomma }}</div>
			</div>

			<div class="challenge-info col-lg-3 col-sm-3 col-xs-6">
				<div class="challenge-label">In the pot</div>
				<div class="challenge-value">${{ challenge.moneyInThePot|floatformat:"-2"|intcomma }}</div>
			</div>
			<div class="challenge-info col-lg-3 col-sm-3 col-xs-6">
				<div class="challenge-label">Players</div>
				<div class="challenge-value">{{ challenge.numPlayers }}</div>
			</div>
			<div class="challenge-info col-lg-3 col-sm-3 col-xs-6">
				<div class="challenge-label">Type</div>
				<div class="challenge-value">
					{% if challenge.isTypeIndividual %}
						<i class="fa fa-user"></i> Individual
					{% elif challenge.isTypeTeam %}
						<i class="fa fa-users"></i> Team
					{% endif %}
				</div>
			</div>
			<div class="challenge-info col-lg-3 col-sm-3 col-xs-6">
				<div class="challenge-label">Style</div>
				<div class="challenge-value">
					{% if challenge.isStyleAllCanWin %}
						All Can Win
					{% elif challenge.isStyleWinnerTakesAll %}
						Winner Takes All
					{% endif %}
				</div>
			</div>
		</div>
	</div>

	{% player_email user %}
	{% player_ante user challenge competitor %}

	{% if canJoin %}
        {% if user.is_authenticated %}
            {% if challenge.isTypeTeam %}
                <div class="btn-group vertical-padding ">
                    <button type="button" class="btn btn-primary btn-lg dropdown-toggle" data-toggle="dropdown">
                        Join this Challenge <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu">
                        {% for team in open_teams %}
                            <li><a href="#" class="join-team" data-id="{{ team.id }}">Join "{{ team.name }}"</a></li>
                        {% endfor %}
						{% if open_teams|length > 0 %}
							<li role="presentation" class="divider"></li>
						{% endif %}
						<li><a href="#" class="create-team">Start a new Team</a></li>
					</ul>
                </div>
            {% else %}
                <button class="join-challenge vertical-padding btn btn-primary btn-lg" type="button" data-toggle="tooltip" data-placement="top" data-html="true" data-title="Go ahead, take the plunge.<br/>You can always change your mind later.">Join this Challenge</button>
            {% endif %}
        {% else %}
            <a class="vertical-padding btn btn-primary btn-lg" href="{% url 'socialauth_begin' 'runkeeper' %}?next={{ request.path }}">Sign In with Runkeeper to Play</a>
        {% endif %}
	{% elif canSwitchTeams %}
		<div class="btn-group vertical-padding ">
			<button type="button" class="btn btn-primary btn-lg dropdown-toggle" data-toggle="dropdown">
				Switch  to a different team <span class="caret"></span>
			</button>
			<ul class="dropdown-menu" role="menu">
				{% for team in open_teams %}
					<li><a href="#" class="join-team" data-id="{{ team.id }}">Switch to "{{ team.name }}"</a></li>
				{% endfor %}
				{% if open_teams|length > 0 %}
					<li role="presentation" class="divider"></li>
				{% endif %}
				<li><a href="#" class="create-team">Start a new Team</a></li>
				<li role="presentation" class="divider"></li>
				<li><a href="#" class="withdraw-challenge">Withdraw from this challenge.</a></li>
			</ul>
		</div>
    {% endif %}

	{% if canWithdraw %}
		<p><small>Having second thoughts?  You can <a href="#" class="withdraw-challenge">withdraw</a> any time before the challenge begins.</small></p>
	{% endif %}

    {% if competitor and not challenge.hasEnded and show_social %}
        <div class="fc-callout fc-callout-info" data-calloutid="social-callout-{{ challenge.id }}">
            <button type="button" class="close close-callout">&times;</button>
            <h4>It's more fun with friends. <small>Share the love</small></h4>
            <button type="button" class="btn btn-default btn-share" data-service="twitter"><i class="fa fa-twitter fa-2x"></i><br/>Tweet</button>
            <button type="button" class="btn btn-default btn-share" data-service="facebook"><i class="fa fa-facebook-square fa-2x"></i><br/>Share</button>
            <button type="button" class="btn btn-default btn-share" data-service="google"><i class="fa fa-google-plus fa-2x"></i><br/>Share</button>
        </div>
    {% endif %}

    <div class="tabbable">
        <ul class="nav nav-tabs" id="challenge_tabs">
            <li class="active"><a href="#leaderboard" data-toggle="tab">Leaderboard</a> </li>
            <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                    More <b class="caret"></b>
                </a>
                <ul class="dropdown-menu">
                    <li><a href="#disqus" data-toggle="tab">Smack talk</a></li>
                    <li><a href="#rules" data-toggle="tab">The Rules</a> </li>
                </ul>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane active" id="leaderboard">
				{% if "DISQUS_SHORTNAME"|fromSettings %}
					<div class="bottom-padding">
                    	<a id="disqus_count" href="#disqus_thread" data-disqus-identifier="{{ disqus_identifier }}">&nbsp;</a>
					</div>
                {% endif %}

			    {% if numPlayers > 0 or teams|length > 0 %}
					<ul class="list-unstyled">
						{% for activity in recentActivities %}
							<li class="bottom-padding">
								<a href="{% url "user_details" activity.user.id %}">{{ activity.user.fullname }}</a> {{ activity.type.name|pastTense }} {{ activity.distance|toMiles|twoDecimals }} miles.
								{% if activity.photo %}
									<a href="{{ activity.photo.url }}" target="_blank"><i title="View Image" class="fa fa-picture-o show-activity-image"></i></a>
								{% endif %}
								<div class="dimmed-text">{{ activity.date|naturaltime|capfirst }} </div>
							</li>
						{% endfor %}
					</ul>

                    <table class="table table-striped leaderboard">
                        <thead>
                            <tr>
                                <th class="rank-column"></th>
                                <th class="avatar-column"></th>
                                <th></th>
                                <th class="miles-column">Miles</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% if challenge.isTypeTeam %}
                            {% for team in teams %}
                                <tr class="team">
                                    <td colspan="3">
                                        <span class="name">{{ team.name }}</span>
                                        <span class="team-rank">{{ forloop.counter|ordinal }} Place</span>
                                    </td>
                                    <td><a href="#" class="popover-link team-total-link" data-toggle="popover" data-html="true" data-trigger="manual" data-placement="left" data-title="{{ team.name }}" data-container="body" data-content='{% spaceless %}
                                    <table class="table table-condensed no-margin-bottom">
                                    	<tr><td>Total Miles</td><td>{{ team.distance|toMiles|twoDecimals }}</td></tr>
										<tr><td> Average Miles</td><td>{{ team.averageDistance|toMiles|twoDecimals }}</td></tr>
									</table>
                                    {% endspaceless %}'>{{ team.averageDistance|toMiles|twoDecimals }}</a></td>
                                </tr>
                                {% for player in team.getMembersWithActivities %}
                                    {% player_row user player challenge forloop.counter %}
                                {% endfor %}
                            {% endfor %}
                        {% elif challenge.isTypeIndividual %}
                            {% for player in players %}
                                {% player_row user player challenge forloop.counter %}
                            {% endfor %}
                        {% endif %}
                        </tbody>
                    </table>
                    <ul class="list-inline">
                        <li><i class="fa fa-heart red" title="Active today"></i> &mdash; Active today.</li>
                        <li><i class="fa fa-trophy"></i> &mdash; Achieved the goal.</li>
                        <li><i class="fa fa-star bronze"></i> &mdash; Achieved 1.5 times the goal.</li>
                        <li><i class="fa fa-star silver"></i> &mdash; Doubled the goal distance.</li>
                        <li><i class="fa fa-star gold"></i> &mdash; Tripled the goal distance.</li>
                    </ul>
                {% else %}
                    <p>
                        This challenge is now open to join.  You could be the first!
                    </p>
                {% endif %}
            </div>
            <div class="tab-pane" id="disqus">
                {% if "DISQUS_SHORTNAME"|fromSettings %}
                    <div id="disqus_thread"></div>
                    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                {% else %}
                    DISQUS not available.
                {% endif %}
            </div>
            <div class="tab-pane" id="rules">
				{% if challenge.isTypeIndividual %}
					<ul>
						<li>Put ${{ challenge.ante|intcomma }} in the pot.</li>
						<li>Track your activity with <a href="http://runkeeper.com/" title="Runkeeper">Runkeeper.</a></li>
						<li>Complete {{ challenge.distance|floatformat:"-1" }} miles in {{ challenge.numDays }} days by {{ approvedActivities|commaSeparated:"or" }} between {{ challenge.startdate|date:"F jS, Y" }} and {{ challenge.enddate|date:"F jS, Y" }}.</li>
						<li>Get Paid.  The money pot is dispersed evenly to those who finished the challenge.</li>
					</ul>
				{% elif challenge.isTypeTeam %}
					<ul>
						<li>Put ${{ challenge.ante|intcomma }} in the pot.</li>
						<li>Join a team.  Teams can have a maximum of 5 players.</li>
						<li>Track your activity with <a href="http://runkeeper.com/" title="Runkeeper">Runkeeper.</a></li>
						<li>Complete {{ challenge.distance|floatformat:"-1" }} miles in {{ challenge.numDays }} days by {{ approvedActivities|commaSeparated:"or" }} between {{ challenge.startdate|date:"F jS, Y" }} and {{ challenge.enddate|date:"F jS, Y" }}.</li>
						<li>A team can only win if everyone on the team has completed the {{ challenge.distance|floatformat:"-1" }} mile challenge.</li>
						<li>Get Paid. The team with the highest average miles per player wins the challenge.  The money pot is dispersed evenly to members of that team.</li>
					</ul>
				{% endif %}
            </div>
        </div>
    </div>
    <script type="text/javascript">
		(function() {
			function round(value) {
				return Math.ceil(value * 100) / 100
			}

			$(".alert").alert();
			$("[data-toggle=tooltip]").tooltip();

			var hidePopovers = function(list) {
				$(list).popover('destroy');
				$(list).removeAttr('data-content');
				$(list).removeAttr('data-showing-now');
			};

			$('body').click(function(evt) {
				if($(evt.target).parents('.popover').length == 0) {
					hidePopovers($('a.popover-link'));
				}
			});

			$('a.team-total-link').popover().click(function(evt) {
				evt.preventDefault();
				evt.stopPropagation(evt.target);

				if(($(evt.target).attr('data-showing-now')) != null) {
					//popup already showing
					hidePopovers($('a.popover-link'));
				}else {
					hidePopovers(_.without($('a.popover-link'), evt.target));
					$(this).popover('show');
					$(this).attr('data-showing-now','true');
				}
			})

			$('a.activities-link').popover().click(function(evt) {
				evt.preventDefault();
				evt.stopPropagation(evt.target);

				if(($(evt.target).attr('data-content')) != null) {
					//popup already showing
					hidePopovers($('a.popover-link'));
				}else {
					hidePopovers(_.without($('a.popover-link'), evt.target));
					var url = $(this).data('url');
					$.get(url, function(result) {
						$(this).attr('data-content', result);
						$(this).popover('show');
					}.bind(this));
				}
			});

			$('body').delegate('.show-more-activities', 'click', function(evt) {
				var link = $(evt.target);
				$('.activities-list tr.hidden').removeClass('hidden');
				link.addClass('hidden');
			});

			$('.btn.settle-up').click(function(evt) {
				evt.preventDefault();
				var win = window.open('http://www.paypal.com', '_blank');
				win.focus();
			});

			$('.close-callout').click(function(evt) {
				evt.preventDefault();
				var $this = $(this),
					callout = $this.parent('.fc-callout'),
					calloutid = callout.data('calloutid');

				callout.remove();

				var hiddenCallouts = $.cookie('hidden_callouts') || '';

				hiddenCallouts = hiddenCallouts.length > 0 ? hiddenCallouts.split(',') : [];

				if( hiddenCallouts.indexOf(calloutid) < 0) {
					hiddenCallouts.push(calloutid);
				}

				$.cookie('hidden_callouts', hiddenCallouts.join(','));
			});

			$('.btn-share').click(function(evt) {
			   evt.preventDefault();
				var $this = $(this),
					service = $this.data('service');

				if(service === 'twitter') {
					var tweetBody = 'Compete. Get Fit. Get Paid.  Join "{{ challenge.name }}" with me! {{ request.build_absolute_uri }} #fitcrown';
					window.open('https://twitter.com/intent/tweet?original_referer={{ request.build_absolute_uri|urlencode }}&text=' + encodeURIComponent(tweetBody), '', 'width=626,height=436')
				}else if(service === 'facebook') {
					window.open('https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent('{{ request.build_absolute_uri }}'),
								'facebook-share-dialog',
								'width=626,height=436');
				}else if(service === 'google') {
					window.open('https://plus.google.com/share?url={{ request.build_absolute_uri|urlencode }}', '', 'width=485,height=450')
				}
			});

			{% if fetchLatest %}
				$.get("{% url 'fetch_latest_activities' challenge.id %}", function(result) {
					if(result && result.success) {
						$('tr.current-player a.distance-enclave').text(round(result.distance));
					}
				});
			{% endif %}

			$('.join-challenge').click(function(evt) {
				evt.preventDefault();
				$.get("{% url 'join_challenge' challenge.id %}", function(result) {
					window.location.reload();
				});
			});

			$('.join-team').click(function(evt) {
				evt.preventDefault();
				var teamID = $(this).data('id');

				var url = "{% url 'join_team' challenge.id '000000' %}".replace(/000000/, teamID.toString());
				$.get(url, function(result) {
					window.location.reload();
				});
			});

			$('.create-team').click(function(evt) {
				evt.preventDefault();
				$.get('{% url 'create_team' challenge.id %}', function(result) {
					window.location.reload();
				});
			});

			$('.withdraw-challenge').click(function(evt) {
				evt.preventDefault();
				var withdraw = window.confirm("Are you sure you want to withdraw from this challenge?")

				if(withdraw) {
					$.get("{% url 'withdraw_challenge' challenge.id %}", function(result) {
						window.location.reload();
					});
				}
			});

			$('#challenge_tabs .dropdown-menu a').on('shown.bs.tab', function(evt) {
				var text = $(this).text();
				$(this).closest('.dropdown').find('.dropdown-toggle').html(text + ' <b class="caret"></b>');
			});

			$('a#disqus_count').click(function(evt) {
				evt.preventDefault();
				$('#challenge_tabs a[href="#disqus"]').tab('show');
			});

			{% if "DISQUS_SHORTNAME"|fromSettings %}
				window.disqus_shortname = '{{ "DISQUS_SHORTNAME"|fromSettings }}';
				window.disqus_identifier = '{{ disqus_identifier }}';

				(function () {
					var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
					dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
					(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);


					var s = document.createElement('script'); s.async = true;
					s.type = 'text/javascript';
					s.src = '//' + disqus_shortname + '.disqus.com/count.js';
					(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
				}());
			{% endif %}
		})();
	</script>
{% endblock %}