{% extends 'base.html' %}
{% load apptags %}
{% load humanize %}
{% load staticfiles %}

{% block head_title %}{{ challenge.name }} | Fit Competition{% endblock %}

{% block head_css %}
    {{ block.super }}
{% endblock %}

{% block content %}
    <div class="row-fluid">
        <ul class="breadcrumb">
            <li><a href="{% url "home" %}">Challenges</a> <span class="divider">&raquo;</span></li>
            <li class="active">{{ challenge.name }}</li>
            <li class="row-icons pull-right">
                <a href="#" class="refresh-healthgraph" title="Reload with the latest from Runkeeper."><i class="icon-refresh"></i></a>
            </li>
        </ul>
        <h2>${{ challenge.moneyInThePot|intcomma }} in the pot!</h2>
        <div class="alert alert-info">
            <a class="close" data-dismiss="alert" href="#">&times;</a>
            <p>
                <strong>
                    {% if competitor %}
                        {% if not challenge.hasEnded %}
                            {{ competitor.user.first_name }}, you are competing in this challenge!
                        {% else %}
                            {{ competitor.user.first_name }}, you competed in this challenge.
                        {% endif %}
                    {% else %}
                        {% if not challenge.hasEnded %}
                            It's not too late to join this challenge.  Get in on the fun!
                        {% else %}
                            This challenge is history.
                        {% endif %}
                    {% endif %}
                </strong>

                {% if not challenge.hasStarted %}
                    It begins on {{ challenge.startdate|date:"F j, Y" }}.
                {% elif challenge.hasEnded %}
                    It ended on {{ challenge.enddate|date:"F j, Y" }}.
                {% else%}
                    <div ng-app="leaderboard" ng-controller="countdown-controller">
                        {% verbatim %}
                            Get moving, there's
                            <ng-pluralize count="data.days" when="{'1': ' 1 Day', 'other': '{} Days'}"></ng-pluralize>,
                            <ng-pluralize count="data.hours" when="{'1': ' 1 Hour', 'other': '{} Hours'}"></ng-pluralize>,
                            <ng-pluralize count="data.minutes" when="{'1': ' 1 Minute', 'other': '{} Minutes'}"></ng-pluralize> and
                            <ng-pluralize count="data.seconds" when="{'1': ' 1 Second', 'other': '{} Seconds'}"></ng-pluralize> left!
                        {% endverbatim %}
                    </div>
                {% endif %}
            </p>
        </div>

        {% if competitor and not competitor.hasPaid %}
            <div class="alert alert-danger">
                <img class="pull-right" src="https://www.paypalobjects.com/webstatic/mktg/logo/pp_cc_mark_37x23.jpg" border="0" alt="PayPal" />
                <p>
                    <span class="label label-important">Heads up!</span>
                    You haven't put money in the pot yet.  Don't Panic; it's ok!  You can take care of that right now.  The easiest way to settle up is to use PayPal.  Here's how&hellip;
                    <ol>
                        <li><a href="https://www.paypal.com" target="_blank">Log in to your PayPal account.</a></li>
                        <li>Click <strong>Send Money</strong> at the top of the page.</li>
                        <li>Fill out the form.
                            <ul>
                                <li>Enter <strong>jason@myheck.net</strong> in the TO field.</li>
                                <li>Specify <strong>${{ challenge.ante|intcomma }}</strong> in the AMOUNT field.</li>
                                <li>Select <strong>I'm sending money to family or friends</strong>.</li>
                            </ul>
                        </li>
                        <li>Continue with the transaction.</li>
                    </ol>
                    Once your payment is received this message will disappear.  Winnings will also be paid to you at the end of the challenge via PayPal.
                </p>

            </div>
        {% endif %}

        {% if canJoin %}
            <button class="join-challenge btn btn-large btn-block btn-success" type="button">Join this Challenge</button>
        {% endif %}
            <h3><i class="icon-trophy icon-large"></i>Leaderboard</h3>
            <div class="row-fluid">
                {% if players %}
                    <table class="table table-striped leaderboard">
                        <thead>
                            <tr>
                                <th class="avatar-column"></th>
                                <th>Player</th>
                                <th class="miles-column">Miles</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for player in players %}
                            <tr class="{% if user == player %}success{% endif %}">
                                <td>
                                    <span class="avatar img-rounded">
                                        <img src="{{ player.medium_picture|avatar }}" class="img-small">
                                        {% if player.total_distance|achievedGoal:challenge.distance %}
                                            <i class="icon-check-sign white"></i>
                                        {% endif %}
                                    </span>
                                </td>
                                <td class="player">
                                    <span class="name"><a href="{{ player.profile_url }}" target="_blank">{{ player.fullname }}</a></span>
                                    <span class="flair">
                                        {% if player.total_distance|overAchiever:challenge.distance %}
                                            <i class="icon-star {% if player.total_distance|doubledGoal:challenge.distance %}golden{% else %}silver{% endif %}"></i>
                                        {% endif %}

                                        {% if player.latest_activity_date|isToday %}
                                            <i class="icon-heart red" title="Active today"></i>
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <a class="activities-link" data-url="{% url "useractivities" player.id challenge.id %}" data-userid="{{ player.id }}" data-toggle="popover" data-placement="left" data-title='{{ player.fullname }}'>
                                        {{ player.total_distance|toMiles|twoDecimals }}
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    <ul class="inline">
                        <li><i class="icon-heart red" title="Active today"></i> &mdash; Active today.</li>
                        <li><i class="icon-check-sign"></i> &mdash; Achieved the goal.</li>
                        <li><i class="icon-star silver"></i> &mdash; Achieved 1.5 times the goal.</li>
                        <li><i class="icon-star golden"></i> &mdash; Doubled the goal distance.</li>
                    </ul>
                {% else %}
                    <p>Crickets.  <a href="#" class="join-challenge">Join this challenge</a> and recruit your friends to compete.</p>
                {% endif %}
            </div>

            <h3><i class="icon-legal icon-large"></i>The Rules</h3>
            <ul>
                <li>Put ${{ challenge.ante|intcomma }} in the pot.</li>
                <li>Complete {{ challenge.distance }} miles in {{ challenge.numDays }} days by {{ approvedActivities|commaSeparated:"or" }} between {{ challenge.startdate|date:"F j, Y" }} and {{ challenge.enddate|date:"F j, Y" }}.</li>
                <li>Track your activity with <a href="http://runkeeper.com/" title="Runkeeper">Runkeeper.</a></li>
                <li>Get Paid.  The money pot is dispersed evenly to those who finished the challenge.</li>
            </ul>
    </div>
    <script type="text/javascript">
        var COUNTDOWN_TARGET_DATE = '{{ challenge.enddate|fullDate }}';
        $(".alert").alert();
        var hidePopovers = function(list) {
            $(list).popover('hide');
        };

        $('body').click(function(evt) {
            if($(evt.target).parents('.popover').length == 0) {
                hidePopovers($('a.activities-link'));
            }
        });

        $('a.activities-link').popover({
            html: true,
            trigger: 'manual'
        }).click(function(evt) {
            evt.stopPropagation(evt.target);
            hidePopovers(_.without($('a.activities-link'), evt.target));

            var url = $(this).data('url');
            $.get(url, function(result) {
                $(this).attr('data-content', result);
                $(this).popover('toggle');
            }.bind(this));
        });

        $('body').delegate('.show-more-activities', 'click', function(evt) {
            var link = $(evt.target);
            $('.activities-list tr.hidden').removeClass('hidden');
            link.addClass('hidden');
        });

        $('.join-challenge').click(function(evt) {
            evt.preventDefault();
            $.get("{% url 'join_challenge' challenge.id %}", function(result) {
                window.location.reload();
            });
        });

        $('.refresh-healthgraph').click(function(evt) {
            evt.preventDefault();
            $.get("{% url 'refresh_user_activities' %}", function(result) {
                window.location.reload();
            });
        });
    </script>
    <script src="{% static "js/leaderboard.js"%}" type="text/javascript"></script>
{% endblock %}