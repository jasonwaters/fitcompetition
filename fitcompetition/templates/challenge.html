{% extends 'base.html' %}
{% load apptags %}
{% load humanize %}
{% load staticfiles %}

{% block head_title %}{{ challenge.name }} | Fit Competition{% endblock %}


{% block head_scripts %}
    {{ block.super }}
    <script type="text/javascript">
        var disqus_shortname = 'fitcompetition'; // required: replace example with your forum shortname
        var disqus_identifier = '{{ disqus_identifier }}';
    </script>
{% endblock %}
{% block head_css %}
    {{ block.super }}
{% endblock %}

{% block content %}
    <div class="row-fluid">
        <div class="hero-unit">
            <h2>{{ challenge.name }}</h2>
            <p>
                Complete {{ challenge.distance|floatformat:"-1" }} miles in {{ challenge.numDays }} days by {{ approvedActivities|commaSeparated:"or" }} between <strong>{{ challenge.startdate|date:"F j, Y" }}</strong> and <strong>{{ challenge.enddate|date:"F j, Y" }}</strong>.
                There's <strong>${{ challenge.moneyInThePot|intcomma }}</strong> in the pot and <strong>{{ numPlayers }}</strong> Competitors.

            {% if competitor %}
                    {% if not challenge.hasEnded %}
                        {{ competitor.user.first_name }}, you are competing in this challenge!
                    {% else %}
                        {{ competitor.user.first_name }}, you competed in this challenge.
                    {% endif %}
                {% else %}
                    {% if not challenge.hasEnded %}
                        It's not too late to join this challenge.  Get in on the fun! Just click the button below, put ${{ challenge.ante|intcomma }} in the pot, and get moving!
                    {% else %}
                        This challenge is history.
                    {% endif %}
                {% endif %}
                </p>
                <p>
                {% if not challenge.hasStarted %}
                    This Challenge will start in {{ challenge.startdate|timeuntil }}.
                {% elif challenge.hasEnded %}
                    This Challenge ended {{ challenge.enddate|timesince }} ago.
                {% else%}
                    <div ng-app="leaderboard" ng-controller="countdown-controller">
                        {% verbatim %}
                        This Challenge is under way, there's
                        <ng-pluralize count="data.days" when="{'1': ' 1 Day', 'other': '{} Days'}"></ng-pluralize>,
                        <ng-pluralize count="data.hours" when="{'1': ' 1 Hour', 'other': '{} Hours'}"></ng-pluralize>,
                        <ng-pluralize count="data.minutes" when="{'1': ' 1 Minute', 'other': '{} Minutes'}"></ng-pluralize> and
                        <ng-pluralize count="data.seconds" when="{'1': ' 1 Second', 'other': '{} Seconds'}"></ng-pluralize> left!
                        {% endverbatim %}
                    </div>
                {% endif %}
            </p>
            {% if canJoin %}
                <button class="join-challenge btn btn-large btn-success" type="button">Join this Challenge</button>
            {% endif %}
        </div>
        {% if challenge.ante > 0 and competitor and not competitor.hasPaid %}
            <div class="alert alert-danger">
                <img class="pull-right" src="https://www.paypalobjects.com/webstatic/mktg/logo/pp_cc_mark_37x23.jpg" border="0" alt="PayPal" />
                <p>
                    <span class="label label-important">Heads up!</span>
                    You haven't put money in the pot yet.  Don't Panic; it's ok!  You can take care of that right now.  The easiest way to settle up is to use PayPal.  Here's how&hellip;
                    <ol>
                        <li><a href="https://www.paypal.com" target="_blank">Log in to your PayPal account.</a></li>
                        <li>Click <strong>Send Money</strong> at the top of the page.</li>
                        <li>Fill out the form.
                            <ul>
                                <li>Enter <strong>jason@myheck.net</strong> in the TO field.</li>
                                <li>Specify <strong>${{ challenge.ante|intcomma }}</strong> in the AMOUNT field.</li>
                                <li>Select <strong>I'm sending money to family or friends</strong>.</li>
                            </ul>
                        </li>
                        <li>Continue with the transaction.</li>
                    </ol>
                    Once your payment is received this message will disappear.  Winnings will also be paid to you at the end of the challenge via PayPal.
                </p>

            </div>
        {% endif %}
        <div class="tabbable">
            <ul class="nav nav-tabs" id="challenge_tabs">
                <li class="active"><a href="#leaderboard" data-toggle="tab">Leaderboard</a> </li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        More <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a href="#disqus" data-toggle="tab">Smack talk</a></li>
                        <li><a href="#rules" data-toggle="tab">The Rules</a> </li>
                    </ul>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="leaderboard">
                    <a id="disqus_count" href="#disqus_thread" data-disqus-identifier="{{ disqus_identifier }}">&nbsp;</a>
                    {% if allPlayers %}
                        <table class="table table-striped leaderboard">
                            <thead>
                                <tr>
                                    <th class="rank-column"></th>
                                    <th class="avatar-column"></th>
                                    <th></th>
                                    <th class="miles-column">Miles</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for player in playersWithActivities %}
                                {% player_row user player challenge forloop.counter %}
                            {% endfor %}
                            {% for player in playersWithoutActivities %}
                                {% player_row user player challenge forloop.counter playersWithActivities|length %}
                            {% endfor %}
                            </tbody>
                        </table>
                        <ul class="inline">
                            <li><i class="icon-heart red" title="Active today"></i> &mdash; Active today.</li>
                            <li><i class="icon-trophy"></i> &mdash; Achieved the goal.</li>
                            <li><i class="icon-star silver"></i> &mdash; Achieved 1.5 times the goal.</li>
                            <li><i class="icon-star golden"></i> &mdash; Doubled the goal distance.</li>
                        </ul>
                    {% else %}
                        <p>
                            This challenge is now open to join.  You could be the first!
                        </p>
                    {% endif %}
                </div>
                <div class="tab-pane" id="disqus">
                    <div id="disqus_thread"></div>
                    <script type="text/javascript">
                        (function() {
                            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                        })();
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </div>
                <div class="tab-pane" id="rules">
                    <ul>
                        <li>Put ${{ challenge.ante|intcomma }} in the pot.</li>
                        <li>Complete {{ challenge.distance|floatformat:"-1" }} miles in {{ challenge.numDays }} days by {{ approvedActivities|commaSeparated:"or" }} between {{ challenge.startdate|date:"F j, Y" }} and {{ challenge.enddate|date:"F j, Y" }}.</li>
                        <li>Track your activity with <a href="http://runkeeper.com/" title="Runkeeper">Runkeeper.</a></li>
                        <li>Get Paid.  The money pot is dispersed evenly to those who finished the challenge.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        var COUNTDOWN_TARGET_DATE = '{{ challenge.enddate|fullDate }}';
        $(".alert").alert();
        var hidePopovers = function(list) {
            $(list).popover('hide');
        };

        $('body').click(function(evt) {
            if($(evt.target).parents('.popover').length == 0) {
                hidePopovers($('a.activities-link'));
            }
        });

        $('a.activities-link').popover({
            html: true,
            trigger: 'manual'
        }).click(function(evt) {
            evt.stopPropagation(evt.target);
            hidePopovers(_.without($('a.activities-link'), evt.target));

            var url = $(this).data('url');
            $.get(url, function(result) {
                $(this).attr('data-content', result);
                $(this).popover('toggle');
            }.bind(this));
        });

        $('body').delegate('.show-more-activities', 'click', function(evt) {
            var link = $(evt.target);
            $('.activities-list tr.hidden').removeClass('hidden');
            link.addClass('hidden');
        });

        $('.join-challenge').click(function(evt) {
            evt.preventDefault();
            $.get("{% url 'join_challenge' challenge.id %}", function(result) {
                window.location.reload();
            });
        });

        $('#challenge_tabs .dropdown-menu li a').on('shown', function(evt) {
           var text = $(this).text();
            $(this).closest('.dropdown').find('.dropdown-toggle').html(text + ' <b class="caret"></b>');
        });

        $('a#disqus_count').click(function(evt) {
           evt.preventDefault();
            $('#challenge_tabs a[href="#disqus"]').tab('show');
        });

        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <script src="{% static "js/leaderboard.js"%}" type="text/javascript"></script>
{% endblock %}