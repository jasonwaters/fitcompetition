{% extends 'base.html' %}
{% load apptags %}
{% load humanize %}

{% block head_title %}Fit Competition{% endblock %}

{% block head_css %}
    {{ block.super }}
{% endblock %}

{% block head_scripts %}
    {{ block.super }}
    <script type="text/javascript">
        $(document).ready(function () {
            var hidePopovers = function(list) {
                $(list).popover('hide');
            };

            $('body').click(function(evt) {
                if($(evt.target).parents('.popover').length == 0) {
                    hidePopovers($('a.activities-link'));
                }
            });

            $('a.activities-link').popover({
                html: true,
                trigger: 'manual'
            }).click(function(evt) {
                hidePopovers(_.without($('a.activities-link'), evt.target));

                $(this).popover('toggle');
                evt.stopPropagation(evt.target);
            });

            $('body').delegate('.show-more-activities', 'click', function(evt) {
                var link = $(evt.target);
                $('.activities-list tr.hidden').removeClass('hidden');
                link.addClass('hidden');
            });
        });
    </script>
{% endblock %}

{% block content %}
    <div data-waters="countdown" data-targetdate="{{ goal.enddate|fullDate }}">
        <div class="inner-countdown">
            Get moving, there's
            <span class="days">
                <span class="countdown-value days-value">{{ goal.enddate|deltaDate:"days" }}</span><span> Days, </span>
            </span>
            <span class="hours">
                <span class="countdown-value hours-value">{{ goal.enddate|deltaDate:"hours" }}</span><span> Hours, </span>
            </span>
            <span class="minutes">
                <span class="countdown-value minutes-value">{{ goal.enddate|deltaDate:"mins" }}</span><span> Minutes and </span>
            </span>
            <span class="seconds">
                <span class="countdown-value seconds-value">{{ goal.enddate|deltaDate:"secs" }}</span><span> Seconds</span>
            </span>
            left!
        </div>
    </div>
    <div class="row-fluid">
        <h3><i class="icon-trophy icon-large"></i> Leaderboard</h3>
        <div class="row-fluid">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th class="miles-column">Miles</th>
                    </tr>
                </thead>
            {% for record in records %}
                <tr>
                    <td class="player">
                        <span class="name">{{ record.name }}</span>
                        {% if record.overAchiever %}
                            <i class="icon-star icon-spin {% if record.doubledGoal %}golden{% else %}silver{% endif %}" title="{% if record.doubledGoal %}Double Goal Distance!!{% else %}1.5 times Goal Distance!{% endif %}"></i>
                        {% endif %}
                        {% if record.activeToday %}
                            <i class="icon-heart red" title="Active today"></i>
                        {% endif %}
                    </td>
                    <td><a class="activities-link" data-userid="{{ record.userID }}" data-toggle="popover" data-placement="left" data-html="true" data-title='{{ record.name }}' data-content='
                        {% spaceless %}
                        <table class="activities-list table table-condensed no-margin-bottom">
                            <thead>
                                <th></th>
                                <th>Date</th>
                                <th>Miles</th>
                                <th>Time</th>
                            </thead>
                            <tbody>
                                {% for activity in record.activities %}
                                    <tr class="{% if forloop.counter > 4 %}hidden{% endif %}">
                                        <td class="activity-icon {% if activity.type == "Walking" %}walking{% else %}running{% endif %}"></td>
                                        <td>{{ activity.start_time|naturalday:"M j" }}</td>
                                        <td>{{ activity.total_distance|toMiles|twoDecimals }}</td>
                                        <td>{{ activity.duration|duration }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if record.activities > 4 %}
                            <div><a class="show-more-activities">{{ record.activities|length|add:"-4" }} more&hellip;</a></div>
                        {% endif %}
                        {% endspaceless %}'>{{ record.totalMiles|twoDecimals }}</a> <i class="icon-check-sign green {% if not record.achievedGoal %}hidden{% endif %}"></i></td>
                </tr>
            {% endfor %}
            </table>
        </div>
        <h3><i class="icon-legal icon-large"></i> The Rules</h3>
        <ul>
            <li>Put ${{ goal.ante|intcomma }} in the pot.</li>
            <li>Run or Walk {{ goal.distance }} miles in {{ goal.numDays }} days.  Between {{ goal.startdate|date:"F j, Y" }} and {{ goal.enddate|date:"F j, Y" }}</li>
            <li>Track your activity with <a href="http://runkeeper.com/" title="Runkeeper">Runkeeper</a></li>
            <li>Get Paid.  The money pot is dispersed evenly to those who finished the challenge.</li>
        </ul>
    </div>
{% endblock %}